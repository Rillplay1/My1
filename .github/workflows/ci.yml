# –ù–∞–∑–≤–∞–Ω–∏–µ workflow ‚Äî –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ GitHub Actions
name: Run Playwright Tests with Allure

# –£—Å–ª–æ–≤–∏—è –∑–∞–ø—É—Å–∫–∞:
# - –ø—Ä–∏ –ø—É—à–µ –≤ –≤–µ—Ç–∫—É main
# - –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ pull request
on:
  push:
    branches:
      - main
  pull_request:

jobs:
  # –ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ (job) ‚Äî —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–≤—Ç–æ—Ç–µ—Å—Ç–æ–≤ (AQA)
  AQA_test:
    # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞ Ubuntu –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏
    runs-on: ubuntu-latest

    steps:

      # –®–∞–≥ 1: –ö–ª–æ–Ω–∏—Ä—É–µ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–∞ CI-–º–∞—à–∏–Ω—É
      - name: Checkout repo
        uses: actions/checkout@v3

      # –®–∞–≥ 2: –°–±–æ—Ä–∫–∞ Docker-–æ–±—Ä–∞–∑–∞ –∏–∑ Dockerfile –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞
      - name: Build Docker image
        run: docker build -t my-playwright-tests .

      # –®–∞–≥ 3: –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
      - name: Run tests in Docker container
        run: |
          docker run --rm \
            -v ${{ github.workspace }}/allure-results:/app/allure-results \
            -v ${{ github.workspace }}/allure-report:/app/allure-report \
            my-playwright-tests \
            /bin/bash -c "pytest --alluredir=allure-results && allure generate allure-results -o allure-report --clean"
      

      # –®–∞–≥ 4: –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç—á—ë—Ç –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç CI
      - name: Upload allure Report Artifact
        uses: actions/upload-artifact@v4
        with:
          name: allure-report     # –ò–º—è –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞
          path: allure-report     # –ü—É—Ç—å –∫ –ø–∞–ø–∫–µ —Å –æ—Ç—á—ë—Ç–æ–º

  deploy_report:
    needs: AQA_test
    runs-on: ubuntu-latest

    steps:
      - name: Download allure Report Artifact
        uses: actions/download-artifact@v4
        with:
          name: allure-report
          path: allure-report

      - name: List downloaded report files (debug)
        run: ls -R

      - name: Archive Allure report
        run: zip -r allure-report.zip allure-report

      - name: Send Allure report to Telegram
        env:
          TELEGRAM_TOKEN: ${{secrets.TELEGRAM_TOKEN}}
          TELEGRAM_CHAT_ID: ${{secrets.TELEGRAM_CHAT_ID}}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendDocument" \
            -F chat_id="${TELEGRAM_CHAT_ID}" \
            -F document=@allure-report.zip \
            -F caption=" Allure –æ—Ç—á–µ—Ç. –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –∏–∑ GitHub Actions"

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
            github_token: ${{ secrets.GITHUB_TOKEN }}
            publish_dir: allure-report

      - name: Send GitHub Pages URL to Telegram
        env:
            TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
            TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
            REPORT_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
              -d chat_id="${TELEGRAM_CHAT_ID}" \
              -d text="üìù Allure –æ—Ç—á–µ—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω: ${REPORT_URL}"