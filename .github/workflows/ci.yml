# –ù–∞–∑–≤–∞–Ω–∏–µ workflow ‚Äî –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ GitHub Actions
name: Run Playwright Tests with Allure

# –£—Å–ª–æ–≤–∏—è –∑–∞–ø—É—Å–∫–∞:
# - –ø—Ä–∏ –ø—É—à–µ –≤ –≤–µ—Ç–∫—É main
# - –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ pull request
on:
  push:
    branches:
      - main
  pull_request:
     branches:
      - main

jobs:
  # –ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ (job) ‚Äî —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–≤—Ç–æ—Ç–µ—Å—Ç–æ–≤ (AQA)
  AQA_test:
    # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞ Ubuntu –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏
    runs-on: ubuntu-latest

    steps:

      # –®–∞–≥ 1: –ö–ª–æ–Ω–∏—Ä—É–µ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–∞ CI-–º–∞—à–∏–Ω—É
      - name: Checkout repo
        uses: actions/checkout@v3

      # –®–∞–≥ 2: –°–±–æ—Ä–∫–∞ Docker-–æ–±—Ä–∞–∑–∞ –∏–∑ Dockerfile –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞
      - name: Build Docker image
        run: docker build -t my-playwright-tests .

      # –®–∞–≥ 3: –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
      - name: Run tests in Docker container
        run: |
          docker run --rm \
            -v ${{ github.workspace }}/allure-results:/app/allure-results \
            -v ${{ github.workspace }}/allure-report:/app/allure-report \
            my-playwright-tests \
            /bin/bash -c "pytest --alluredir=allure-results && allure generate allure-results -o allure-report --clean"
      

      # –®–∞–≥ 4: –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç—á—ë—Ç –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç CI
      - name: Upload allure Report Artifact
        uses: actions/upload-artifact@v4
        with:
          name: allure-report     # –ò–º—è –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞
          path: allure-report     # –ü—É—Ç—å –∫ –ø–∞–ø–∫–µ —Å –æ—Ç—á—ë—Ç–æ–º

  deploy_report: # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π job –ø–æ–¥ –Ω–∞–∑–≤–∞–Ω–∏–µ–º "deploy_report"
    needs: AQA_test  # –≠—Ç–∞ job –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è job "AQA_test"
    runs-on: ubuntu-latest  # –ó–∞–ø—É—Å–∫ job –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ —Å Ubuntu –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏

    steps:  # –°–ø–∏—Å–æ–∫ —à–∞–≥–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω—ã –≤ —Ä–∞–º–∫–∞—Ö —ç—Ç–æ–π job
      - name: Download allure Report Artifact # –®–∞–≥ 1: –∑–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞ (–æ—Ç—á—ë—Ç–∞ Allure) –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–π job
        uses: actions/download-artifact@v4  # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≥–æ—Ç–æ–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ GitHub Actions –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
        with:
          name: allure-report  # –ò–º—è –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ —Å–∫–∞—á–∞—Ç—å (—Ç–∞–∫–æ–µ –∂–µ –∏–º—è –±—ã–ª–æ –≤ upload-artifact)
          path: allure-report # –õ–æ–∫–∞–ª—å–Ω–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è, –∫—É–¥–∞ –±—É–¥–µ—Ç —Å–∫–∞—á–∞–Ω –∞—Ä—Ç–µ—Ñ–∞–∫—Ç (–≤—Å—ë —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–æ–ø–∞–¥—ë—Ç –≤ —ç—Ç—É –ø–∞–ø–∫—É)

      - name: List downloaded report files (debug) # –®–∞–≥ 2: –æ—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥ ‚Äî –≤—ã–≤–æ–¥–∏—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ñ–∞–π–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
        run: ls -R  # –†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –≤—ã–≤–æ–¥ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ –∏ –ø–∞–ø–æ–∫ –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –∏–º–µ–Ω–Ω–æ —Å–∫–∞—á–∞–ª–æ—Å—å)

#      - name: Archive Allure report
#        run: zip -r allure-report.zip allure-report
#
#      - name: Send Allure report to Telegram
#        env:
#          TELEGRAM_TOKEN: ${{secrets.TELEGRAM_TOKEN}}
#          TELEGRAM_CHAT_ID: ${{secrets.TELEGRAM_CHAT_ID}}
#        run: |
#          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendDocument" \
#            -F chat_id="${TELEGRAM_CHAT_ID}" \
#            -F document=@allure-report.zip \
#            -F caption=" Allure –æ—Ç—á–µ—Ç. –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –∏–∑ GitHub Actions"

      - name: Deploy to GitHub Pages  # –®–∞–≥ 3: –ü—É–±–ª–∏–∫–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ –Ω–∞ GitHub Pages
        uses: peaceiris/actions-gh-pages@v4  # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≥–æ—Ç–æ–≤—ã–π GitHub Action –æ—Ç peaceiris –¥–ª—è –¥–µ–ø–ª–æ—è –Ω–∞ gh-pages
        with:
            github_token: ${{ secrets.GITHUB_TOKEN }} # –°–µ–∫—Ä–µ—Ç–Ω—ã–π —Ç–æ–∫–µ–Ω, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º—ã–π GitHub, –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø—É—à–∏—Ç—å –≤ –≤–µ—Ç–∫—É gh-pages
            publish_dir: allure-report # –£–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫—É—é –ø–∞–ø–∫—É –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –Ω–∞ GitHub Pages (–≤ –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ –ø–∞–ø–∫—É —Å Allure-–æ—Ç—á–µ—Ç–æ–º)

      - name: Send GitHub Pages URL to Telegram # –®–∞–≥ 4: –û—Ç–ø—Ä–∞–≤–∫–∞ —Å—Å—ã–ª–∫–∏ –Ω–∞ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–π –æ—Ç—á–µ—Ç –≤ Telegram
        env:
            TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }} # –¢–æ–∫–µ–Ω Telegram-–±–æ—Ç–∞ (–∏–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤)
            TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }} # ID —á–∞—Ç–∞, –∫—É–¥–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ (–∏–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤)
        run: |
            REPORT_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
              -d chat_id="${TELEGRAM_CHAT_ID}" \
              -d text="üìù Allure –æ—Ç—á–µ—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω: ${REPORT_URL}"